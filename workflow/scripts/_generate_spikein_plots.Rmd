---
title: "Spike-in Control QC Assessment"
author: "Samantha Sevilla"
date: "`r Sys.Date()`"
output:
  html_document:
params:
  bam_list: ""
  spikein_control: "NC_000913.3"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# list packages
list.of.packages=c("ggplot2","DT")
list.of.bioconductor.packages=c("chipenrich")

#install as needed
new.packages <- list.of.bioconductor.packages[!(list.of.bioconductor.packages %in% installed.packages()[,"Package"])]

if(length(new.packages)) {
  print(new.packages)
  BiocManager::install(new.packages, INSTALL_opts = '--no-lock')
}

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) {
  print(new.packages)
  install.packages(new.packages, INSTALL_opts = '--no-lock')
}

# load packages
invisible(lapply(list.of.packages, library, character.only = TRUE))
invisible(lapply(list.of.bioconductor.packages, library, character.only = TRUE))
```


```{r params, include=FALSE, echo=FALSE}
# set params
bam_list=params$bam_list
spikein_control=params$spikein_control
debug="N"

if (debug=="Y"){
  spikein_control="NC_000913.3"
  bam_list=""
}

# set up bam list
bam_list==as.list(strsplit(peak_list, 'xxx'))[[1]]

# source functions file
source(sourcefile)
```


```{r df, include=FALSE}
# input list of all bams
# /data/sevillas2/carlisle/v2.0/results/bam/HN6_H4K20me3_2.dedup.bam.idxstats

# create df
proj_df=data.frame()
for (bam in bam_list){
  # example: # /data/sevillas2/carlisle/v2.0/results/bam/HN6_H4K20me3_2.dedup.bam.idxstats
  proj_df[nrow(proj_df)+1,"bam"]=bam
  
  # example: HN6_H4K20me3_2.dedup.bam.idxstats
  ext=strsplit(bam,"/")[[1]][length(strsplit(bam,"/"))]
  
  # example: HN6_H4K20me3_2
  proj_df[rowid,"repid"]=strsplit(ext,".")[[1]][1]
  
  # example: HN6_H4K20me3
  proj_df[rowid,"sampleid"]=strsplit(proj_df[rowid,"repid"],"_")
}

DT::datatable(proj_df)
```

```{r spikeplot, include=FALSE}
GENERATE_SPIKEIN_PLOT(input_df=proj_df,
                      spike_type=spikein_control)
```

