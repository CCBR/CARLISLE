from os.path import join

def qc(wildcards):
    files=[]
    if "LIBRARY" in SPIKED:
        lib=expand(join(WORKDIR,"clean_library_size.csv"))
        files.extend(lib)
    q=expand(join(RESULTSDIR,'qc', 'multiqc_report.html'))
    files.extend(q)
    return files

def run_macs2(wildcards):
    files=[]
    if "narrowPeak" in PEAKTYPE:
        n=expand(join(RESULTSDIR,"peaks","{qthresholds}","macs2","{replicate}","{replicate}.{dupstatus}_peaks.narrowPeak"),qthresholds=QTRESHOLDS,replicate=REPLICATES,dupstatus=DUPSTATUS),
        files.extend(n)
        n2=expand(join(RESULTSDIR,"peaks","{qthresholds}","macs2","{replicate}","{replicate}.{dupstatus}_peaks.narrow.bigbed"),qthresholds=QTRESHOLDS,replicate=REPLICATES,dupstatus=DUPSTATUS),
        files.extend(n2)        
    if "broadPeak" in PEAKTYPE:
        b=expand(join(RESULTSDIR,"peaks","{qthresholds}","macs2","{replicate}","{replicate}.{dupstatus}_peaks.broadPeak"),qthresholds=QTRESHOLDS,replicate=REPLICATES,dupstatus=DUPSTATUS),
        files.extend(b)
        b2=expand(join(RESULTSDIR,"peaks","{qthresholds}","macs2","{replicate}","{replicate}.{dupstatus}_peaks.broad.bigbed"),qthresholds=QTRESHOLDS,replicate=REPLICATES,dupstatus=DUPSTATUS),
        files.extend(b2)
    return files

def run_seacr(wildcards):
    files=[]
    if "norm.stringent.bed" in PEAKTYPE:
        s=expand(join(RESULTSDIR,"peaks","{qthresholds}","seacr","{treatment}_vs_{control}","{treatment}_vs_{control}.{dupstatus}.norm.stringent.bed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(s)
        s2=expand(join(RESULTSDIR,"peaks","{qthresholds}","seacr","{treatment}_vs_{control}","{treatment}_vs_{control}.{dupstatus}.norm.stringent.bigbed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(s2)
    if "non.stringent.bed" in PEAKTYPE:
        s=expand(join(RESULTSDIR,"peaks","{qthresholds}","seacr","{treatment}_vs_{control}","{treatment}_vs_{control}.{dupstatus}.non.stringent.bed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(s)
        s2=expand(join(RESULTSDIR,"peaks","{qthresholds}","seacr","{treatment}_vs_{control}","{treatment}_vs_{control}.{dupstatus}.non.stringent.bigbed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(s2)
    if "norm.relaxed.bed" in PEAKTYPE:
        r=expand(join(RESULTSDIR,"peaks","{qthresholds}","seacr","{treatment}_vs_{control}","{treatment}_vs_{control}.{dupstatus}.norm.relaxed.bed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(r)
        r2=expand(join(RESULTSDIR,"peaks","{qthresholds}","seacr","{treatment}_vs_{control}","{treatment}_vs_{control}.{dupstatus}.norm.relaxed.bigbed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(r2)
    if "non.relaxed.bed" in PEAKTYPE:
        r=expand(join(RESULTSDIR,"peaks","{qthresholds}","seacr","{treatment}_vs_{control}","{treatment}_vs_{control}.{dupstatus}.non.relaxed.bed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(r)
        r2=expand(join(RESULTSDIR,"peaks","{qthresholds}","seacr","{treatment}_vs_{control}","{treatment}_vs_{control}.{dupstatus}.non.relaxed.bigbed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(r2)
    return files

def run_gopeaks(wildcards):
    files=[]
    if "narrowGo_peaks.bed" in PEAKTYPE:
        n=expand(join(RESULTSDIR,"peaks","{qthresholds}","gopeaks","{treatment}_vs_{control}.{dupstatus}.narrowGo_peaks.bed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(n)
        n2=expand(join(RESULTSDIR,"peaks","{qthresholds}","gopeaks","{treatment}_vs_{control}.{dupstatus}.narrowGo_peaks.bigbed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(n2)
    if "broadGo_peaks.bed" in PEAKTYPE:
        b=expand(join(RESULTSDIR,"peaks","{qthresholds}","gopeaks","{treatment}_vs_{control}.{dupstatus}.broadGo_peaks.bed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(b)
        b2=expand(join(RESULTSDIR,"peaks","{qthresholds}","gopeaks","{treatment}_vs_{control}.{dupstatus}.broadGo_peaks.bigbed"),qthresholds=QTRESHOLDS,treatment=TREATMENTS,control=CONTROLS,dupstatus=DUPSTATUS),
        files.extend(b2)
    return files

def run_contrasts(wildcards):
    files=[]
    if config["run_contrasts"] == "Y":
        files.append(join(RESULTSDIR,"replicate_sample.tsv"))
        bb=expand(join(RESULTSDIR,"peaks","{qthresholds}","contrasts","bed_bedgraph_paths.tsv"),qthresholds=QTRESHOLDS)
        files.extend(bb)
        inputs=expand([join(RESULTSDIR,"peaks","{qs}","contrasts","{c1}_vs_{c2}__{ds}__{pt}","{c1}_vs_{c2}__{ds}__{pt}_inputs.txt")],zip,qs=QS,c1=C1s,c2=C2s,ds=DS,pt=PT)
        files.extend(inputs)
        cms=expand([join(RESULTSDIR,"peaks","{qs}","contrasts","{c1}_vs_{c2}__{ds}__{pt}","{c1}_vs_{c2}__{ds}__{pt}_countsmatrix.txt")],zip,qs=QS,c1=C1s,c2=C2s,ds=DS,pt=PT)
        files.extend(cms)
        fcms=expand([join(RESULTSDIR,"peaks","{qs}","contrasts","{c1}_vs_{c2}__{ds}__{pt}","{c1}_vs_{c2}__{ds}__{pt}_fragmentscountsmatrix.txt")],zip,qs=QS,c1=C1s,c2=C2s,ds=DS,pt=PT)
        files.extend(fcms)
        results=expand([join(RESULTSDIR,"peaks","{qs}","contrasts","{c1}_vs_{c2}__{ds}__{pt}","{c1}_vs_{c2}__{ds}__{pt}_AUCbased_diffresults.txt")],zip,qs=QS,c1=C1s,c2=C2s,ds=DS,pt=PT)
        files.extend(results)
        htmls=expand([join(RESULTSDIR,"peaks","{qs}","contrasts","{c1}_vs_{c2}__{ds}__{pt}","{c1}_vs_{c2}__{ds}__{pt}_AUCbased_diffanalysis.html")],zip,qs=QS,c1=C1s,c2=C2s,ds=DS,pt=PT)
        files.extend(htmls)
        bbs=expand([join(RESULTSDIR,"peaks","{qs}","contrasts","{c1}_vs_{c2}__{ds}__{pt}","{c1}_vs_{c2}__{ds}__{pt}_AUCbased_diffresults.bigbed")],zip,qs=QS,c1=C1s,c2=C2s,ds=DS,pt=PT)
        files.extend(bbs)
        fresults=expand([join(RESULTSDIR,"peaks","{qs}","contrasts","{c1}_vs_{c2}__{ds}__{pt}","{c1}_vs_{c2}__{ds}__{pt}_fragmentsbased_diffresults.txt")],zip,qs=QS,c1=C1s,c2=C2s,ds=DS,pt=PT)
        files.extend(fresults)
        fhtmls=expand([join(RESULTSDIR,"peaks","{qs}","contrasts","{c1}_vs_{c2}__{ds}__{pt}","{c1}_vs_{c2}__{ds}__{pt}_fragmentsbased_diffanalysis.html")],zip,qs=QS,c1=C1s,c2=C2s,ds=DS,pt=PT)
        files.extend(fhtmls)
        fbbs=expand([join(RESULTSDIR,"peaks","{qs}","contrasts","{c1}_vs_{c2}__{ds}__{pt}","{c1}_vs_{c2}__{ds}__{pt}_fragmentsbased_diffresults.bigbed")],zip,qs=QS,c1=C1s,c2=C2s,ds=DS,pt=PT)
        files.extend(fbbs)
        venns=expand([join(RESULTSDIR,"peaks","{qs}","contrasts","{c1}_vs_{c2}__{ds}__{pt}","{c1}_vs_{c2}__{ds}__{pt}_venn.pdf")],zip,qs=QS,c1=C1s,c2=C2s,ds=DS,pt=PT)
        files.extend(venns)
    return files

def get_annotation_macs2(wildcards):
    files=[]
    if ("narrowPeak" in PEAKTYPE) or ("broadPeak" in PEAKTYPE):
        peaks=expand(join(RESULTSDIR,"annotation","{qthresholds}","{macs_types}","{replicate}","{replicate}.{dupstatus}.annotation.txt"),qthresholds=QTRESHOLDS,macs_types=MACS_TYPES,replicate=REPLICATES,dupstatus=DUPSTATUS)
        files.extend(peaks)
    return files

def get_annotation_s_and_g(wildcards):
    files=[]
    if ("narrowGo_peaks.bed" in PEAKTYPE) or ("broadGo_peaks.bed" in PEAKTYPE) or ("norm.stringent.bed" in PEAKTYPE) or ("norm.relaxed.bed" in PEAKTYPE) or ("non.stringent.bed" in PEAKTYPE) or ("non.relaxed.bed" in PEAKTYPE):
        f=expand(join(RESULTSDIR,"annotation","{qthresholds}","{s_and_g_types}","{t_and_c}","{t_and_c}.{dupstatus}.annotation.txt"),qthresholds=QTRESHOLDS,s_and_g_types=S_AND_G_TYPES,t_and_c=TREATMENT_CONTROL_LIST,dupstatus=DUPSTATUS)
        files.extend(f)
    return files

def get_motif_analysis(wildcards):
    files=[]
    # from rose
    bed=expand(join(RESULTSDIR,"annotation","{qthresholds}","{peak_types}","{treatment}","{treatment}.{dupstatus}.no_TSS_{s_dist}.bed"),qthresholds=QTRESHOLDS,peak_types=PEAKTYPE,treatment=TREATMENTS,dupstatus=DUPSTATUS,s_dist=S_DISTANCE)
    files.extend(bed)
    bed=expand(join(RESULTSDIR,"annotation","{qthresholds}","{peak_types}","{treatment}","{treatment}.{dupstatus}.{s_dist}","{treatment}_AllStitched.table.super.summits.bed"),qthresholds=QTRESHOLDS,peak_types=PEAKTYPE,treatment=TREATMENTS,dupstatus=DUPSTATUS,s_dist=S_DISTANCE)
    files.extend(bed)
    
    # from findMotif
    html=expand(join(RESULTSDIR,"annotation","{qthresholds}","{peak_types}","{treatment}","{treatment}.{dupstatus}.motifs","knownResults.html"),qthresholds=QTRESHOLDS,peak_types=PEAKTYPE,treatment=TREATMENTS,dupstatus=DUPSTATUS)
    files.extend(html)
    return files

include: "rules/init.smk"
include: "rules/align.smk"
include: "rules/qc.smk"
include: "rules/peakcalls.smk"
include: "rules/diff.smk"
include: "rules/annotations.smk"

rule all:
    input:
        ##########################################
        ### required files
        ##########################################
        ## QC rules
        unpack(qc),
        
        ## alignment stats yaml files and stats table
        expand(join(RESULTSDIR,"alignment_stats","{replicate}.alignment_stats.yaml"),replicate=REPLICATES),
        join(RESULTSDIR,"alignment_stats","alignment_stats.tsv"),

        # ## PEAKCALLS rules
        unpack(run_macs2),
        unpack(run_seacr),
        unpack(run_gopeaks),
        unpack(run_contrasts),

        # # # ## ANNOTATION
        unpack(get_annotation_macs2),
        unpack(get_annotation_s_and_g),
        unpack(get_motif_analysis)

        ##########################################
        ### intermediate files
        ##########################################
        # bowtie2 index building
        # join(BOWTIE2_INDEX,"ref.1.bt2"),
        # join(BOWTIE2_INDEX,"ref.len"),
        # join(BOWTIE2_INDEX,"spikein.len"),

        ## ALIGN RULES
        # filtered bams
        # expand(join(RESULTSDIR,"bam","{replicate}.{dupstatus}.bam"),replicate=REPLICATES,dupstatus=DUPSTATUS),
        # expand(join(RESULTSDIR,"bam","{replicate}.{dupstatus}.bam.idxstats"),replicate=REPLICATES,dupstatus=DUPSTATUS),
        
        # join(RESULTSDIR,"alignment_stats","alignment_stats.tsv"),
        
        # # bedgraphs and bigwigs
        # expand(join(RESULTSDIR,"fragments","{replicate}.{dupstatus}.fragments.bed"),replicate=REPLICATES,dupstatus=DUPSTATUS),
        # expand(join(RESULTSDIR,"bedgraph","{replicate}.{dupstatus}.bedgraph"),replicate=REPLICATES,dupstatus=DUPSTATUS),
        # expand(join(RESULTSDIR,"bigwig","{replicate}.{dupstatus}.bigwig"),replicate=REPLICATES,dupstatus=DUPSTATUS),

